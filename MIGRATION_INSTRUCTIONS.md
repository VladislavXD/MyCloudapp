# Инструкции по миграции базы данных

## Что изменилось?

Была добавлена поддержка групп сервисов и их тарифов для обычных пользователей. Теперь пользователи могут:
- ✅ Просматривать группы сервисов (MC Video, SSL, VPS и т.д.)
- ✅ Заходить внутрь групп и видеть доступные тарифы
- ✅ Оформлять заказы на тарифы из групп сервисов

## Необходимые действия

### 1. Запустить миграцию базы данных

Выполните SQL миграцию для добавления поддержки `service_plan_id` в таблицу `orders`:

```bash
# Через MySQL CLI
mysql -u your_user -p vps_billing < backend/migrations/001-add-service-plan-to-orders.sql

# Или через Node.js скрипт (если база доступна)
cd backend
node scripts/add-service-plan-to-orders.js
```

### 2. Убедитесь, что таблицы групп сервисов созданы

Если вы еще не создали таблицы для групп сервисов, запустите:

```bash
cd backend
node scripts/setup-service-groups.js
```

Этот скрипт создаст:
- Таблицу `service_groups` (группы сервисов)
- Таблицу `service_plans` (тарифы внутри групп)
- Таблицу `plan_fields` (динамические поля для тарифов)
- Тестовые данные для проверки

### 3. Перезапустите бэкенд

После миграции перезапустите сервер:

```bash
cd backend
npm start
```

## Что было исправлено?

### 1. **Публичный доступ к группам сервисов** ✅
- Создан новый API `/api/service-groups` для обычных пользователей
- Создан новый API `/api/service-plans` для получения тарифов группы
- Зарегистрированы роуты в `app.js`

### 2. **Обновленный интерфейс пользователя** ✅
- Добавлены вкладки "Сервисы" и "VPS" в главном экране
- Карточки групп сервисов с иконками и количеством тарифов
- Новая страница деталей группы с тарифами
- Возможность оформить заказ на любой тариф

### 3. **Автогенерация slug** ✅
- Slug теперь генерируется автоматически из названия на русском
- Поддержка транслитерации русских букв в латиницу
- В режиме редактирования slug нельзя изменить (только при создании)

### 4. **Поддержка заказов для тарифов** ✅
- API заказов теперь поддерживает как `vps_plan_id`, так и `service_plan_id`
- Добавлена миграция для таблицы `orders`

## Структура новых файлов

```
backend/
├── api/services/
│   ├── service-groups.js          # Публичный API для групп
│   ├── service-plans.js           # Публичный API для тарифов
│   ├── service-groups-admin.js    # Админский API для групп
│   └── service-plans-admin.js     # Админский API для тарифов
├── migrations/
│   └── 001-add-service-plan-to-orders.sql  # SQL миграция
└── scripts/
    ├── setup-service-groups.js    # Создание таблиц и тестовых данных
    └── add-service-plan-to-orders.js  # JS скрипт миграции

app/
├── (user)/
│   ├── home.tsx                   # Обновленный главный экран с вкладками
│   └── service-group-details.tsx  # Новая страница деталей группы
└── (admin)/
    ├── service-groups.tsx         # Админка групп (без изменений)
    └── service-group-form.tsx     # Форма группы с автогенерацией slug
```

## Проверка работы

1. **Админка**: Зайдите в админку и создайте новую группу сервисов
   - Slug будет сгенерирован автоматически
   - Добавьте тарифы внутрь группы

2. **Пользователь**: Зайдите как обычный пользователь
   - Переключитесь на вкладку "Сервисы"
   - Вы должны увидеть созданные группы
   - Нажмите на группу, чтобы увидеть тарифы
   - Попробуйте оформить заказ

## Возможные проблемы

### Ошибка: "Column 'service_plan_id' does not exist"
**Решение**: Запустите миграцию (шаг 1 выше)

### Ошибка: "Table 'service_groups' doesn't exist"
**Решение**: Запустите `node scripts/setup-service-groups.js`

### Группы не отображаются для пользователя
**Проверьте**:
- В таблице `service_groups` поле `is_active = true`
- В таблице `service_plans` поле `is_active = true`
- Токен пользователя валиден

## Обратная связь

Если есть вопросы или проблемы, проверьте логи бэкенда для подробностей.
